rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() { return request.auth != null; }
    function me() { return request.auth.uid; }

    // ---------- users ----------
    match /users/{uid} {
      // Any signed-in user can view profiles
      allow read: if signedIn();

      // Only the owner can write their own profile
      allow create, update: if signedIn() && me() == uid
        // Whitelist allowed fields to avoid arbitrary writes
        && request.resource.data.keys().hasOnly(
             ['displayName','role','location','website','bio','photoURL','tags','searchable']
           )
        // (optional) light validation
        && (request.resource.data.displayName is string && request.resource.data.displayName.size() <= 60)
        && (request.resource.data.role is string ? request.resource.data.role.size() <= 60 : true)
        && (request.resource.data.location is string ? request.resource.data.location.size() <= 120 : true)
        && (request.resource.data.website is string ? request.resource.data.website.size() <= 300 : true)
        && (request.resource.data.bio is string ? request.resource.data.bio.size() <= 2000 : true)
        && (request.resource.data.photoURL is string ? request.resource.data.photoURL.size() <= 500 : true);

      allow delete: if signedIn() && me() == uid;
    }

    // ---------- sumas ----------
    match /sumas/{doc} {
      allow read: if signedIn();
      allow create, update, delete: if signedIn();
    }

    // ---------- chats (1:1 threads) ----------
    match /chats/{chatId} {

      // Read chat only if you're a participant
      allow read: if signedIn() && me() in resource.data.participants;

      // Create chat: creator must be a participant; enforce 1:1 non-group
      allow create: if signedIn()
                    && me() in request.resource.data.participants
                    && request.resource.data.participants is list
                    && request.resource.data.participants.size() == 2
                    && request.resource.data.isgroupchat == false;

      // Update/delete chat only if you're a participant (e.g., lastmessage/lastmessagetime)
      allow update, delete: if signedIn() && me() in resource.data.participants;

      // ----- messages subcollection -----
      match /messages/{msgId} {
        // Read messages if you're a participant of the parent chat
        allow read: if signedIn()
          && me() in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;

        // Create message only if you're a participant and the senderID is you
        // NOTE: keep the field names exactly as used by your client ('createdat' here).
        allow create: if signedIn()
          && me() in get(/databases/$(database)/documents/chats/$(chatId)).data.participants
          && request.resource.data.senderID == me()
          && request.resource.data.keys().hasOnly(['senderID','text','status','createdat','type']);

        // Keep messages immutable from the client
        allow update, delete: if false;
      }
    }
  }
}

